# Nix Packages

This directory contains Nix package definitions for the Identus Mediator.

## Outputs

### Packages

- **`mediator`** - Main mediator application built with Scala/sbt. Includes webapp frontend compiled via Scala.js. The build uses cached sbt dependencies and npm modules for reproducibility.

- **`mediator-docker`** - Docker image containing the mediator application with minimal runtime dependencies (coreutils, bash, curl). Tagged with the package version by default.

- **`mediator-docker-latest`** - Same as `mediator-docker` but tagged as `latest`.

- **`mediator-docker-cross-linux-amd64`** - Cross-compiled Docker image for Linux AMD64.

- **`mediator-docker-cross-linux-arm64`** - Cross-compiled Docker image for Linux ARM64.

**Note:** Docker images and cross-compilation are only available on Linux hosts.

## Usage

```bash
# Build the mediator application
nix build .#mediator

# Build Docker image (Linux only)
nix build .#mediator-docker

# Build cross-platform Docker images (Linux only)
# These create Docker images for specific architectures regardless of your host architecture
nix build .#mediator-docker-cross-linux-amd64
nix build .#mediator-docker-cross-linux-arm64

# Build for different system (requires remote or emulated builder for cross-building)
nix build .#mediator --system x86_64-linux
nix build .#mediator --system aarch64-linux

# Load Docker image
docker load < result

# Enter development shell
nix develop
```

## Limitations

### Building on macOS

Docker images cannot be built natively on macOS, and cross-compilation is not yet supported in this repository yet.
To build Docker images or Linux-specific packages from macOS, you need to configure a Linux remote builder.

Nix will automatically delegate builds to the remote builder when you specify a different system architecture:

For setup instructions, see the [official Nix documentation on distributed builds](https://nixos.org/manual/nix/stable/advanced-topics/distributed-builds.html).

## Managing Dependencies and Hashes

The mediator build uses Nix's fixed-output derivations to cache dependencies for reproducible builds. This involves managing two main dependency sets:

### SBT Dependencies

The `mediator-sbt-dependencies.nix` file contains all Scala/sbt dependencies required to build the mediator application. It uses a fixed-output derivation with a content hash to ensure reproducibility.

**Location:** `nix/packages/mediator/mediator-sbt-dependencies.nix`

**Key attribute:**
- `outputHash` (line 20): SHA-256 hash of the sbt dependency cache

**When to update:**
- After adding or updating Scala dependencies in `build.sbt`
- After changing sbt plugin versions in `project/plugins.sbt`
- When you see dependency-related build failures

**How to update the hash:**

1. Modify your dependencies in `build.sbt` or `project/plugins.sbt`
2. Set `outputHash` to an empty string `""` or a fake hash in `mediator-sbt-dependencies.nix`
3. Run `nix build .#mediator` (the build will fail)
4. Nix will display the expected hash in the error message:
   ```
   error: hash mismatch in fixed-output derivation
   specified: sha256-AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=
   got:       sha256-XhFTsKrCK5TNmAnmbL/zcJuxCfXEzzZwQSdXTOJzKVI=
   ```
5. Copy the hash from the `got:` line and update `outputHash` in `mediator-sbt-dependencies.nix`
6. Rebuild with `nix build .#mediator` to verify

### Node Modules

The `webapp-node-modules` package contains npm dependencies for the Scala.js frontend webapp. It uses Nix's `buildNpmPackage` with a content hash for the node_modules.

**Location:** `nix/packages/mediator/webapp-node-modules/`

**Key attributes:**
- `npmDepsHash` (line 12 in `default.nix`): SHA-256 hash of npm dependencies
- `package.json`: npm package manifest (generated by Scala.js bundler)
- `package-lock.json`: npm dependency lockfile (generated by Scala.js bundler)

**When to update:**
- After adding or updating npm packages via ScalablyTyped in the webapp
- When the Scala.js bundler generates new package.json/package-lock.json files
- When you see npm-related build failures

**How to update package.json and package-lock.json:**

The project provides a convenient update script accessible via passthru:

```bash
# From the repository root, run:
nix run .#mediator.updateNodeModules
```

This script will:
1. Run `sbt clean mediator/compile` to generate fresh package.json and package-lock.json
2. Copy the generated files from `webapp/target/scala-3.6.4/scalajs-bundler/main/` to `nix/packages/mediator/webapp-node-modules/`
3. Display instructions for updating the hash

**How to update the npmDepsHash:**

After running the update script above:

1. Set `npmDepsHash` to an empty string `""` in `nix/packages/mediator/webapp-node-modules/default.nix`
2. Run `nix build .#mediator` (the build will fail)
3. Nix will display the expected hash in the error message:
   ```
   error: hash mismatch in fixed-output derivation
   specified: sha256-AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=
   got:       sha256-0YcjHDgxoF5S9ZzufulA9KjI8S9ghoayJITQe/UVVFo=
   ```
4. Copy the hash from the `got:` line and update `npmDepsHash` in `webapp-node-modules/default.nix`
5. Rebuild with `nix build .#mediator` to verify
